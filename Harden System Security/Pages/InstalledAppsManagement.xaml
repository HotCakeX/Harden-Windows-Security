<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="HardenSystemSecurity.Pages.InstalledAppsManagement"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:CC="using:CommonCore.Others"
    xmlns:customUI="using:AppControlManager.CustomUIElements"
    xmlns:vm="using:HardenSystemSecurity.ViewModels"
    FlowDirection="{x:Bind ViewModel.AppSettings.ApplicationGlobalFlowDirection, Mode=OneWay}"
    xmlns:animatedvisuals="using:AnimatedVisuals">

    <Grid>

        <Grid.Resources>

            <!-- For the Packaged Apps ListView Grouping -->
            <CollectionViewSource x:Name="PackagedAppsCollectionViewSource"
                           Source="{x:Bind ViewModel.AppsListItemsSource, Mode=OneWay}"
                           IsSourceGrouped="True"/>

            <!-- Defines a single App that is displayed in the ListView -->
            <DataTemplate x:Key="PackagedAppsListViewTemplate" x:DataType="CC:PackagedAppView">
                <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Margin="4,2"
                        Padding="16,12">

                    <!-- Hover and Selection Visual States -->
                    <Border.BackgroundTransition>
                        <BrushTransition Duration="0:0:0.2"/>
                    </Border.BackgroundTransition>

                    <VisualStateManager.VisualStateGroups>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal"/>
                            <VisualState x:Name="PointerOver">
                                <VisualState.Setters>
                                    <Setter Target="MainBorder.Background" Value="{ThemeResource LayerFillColorAltBrush}"/>
                                    <Setter Target="MainBorder.BorderBrush" Value="{ThemeResource AccentFillColorSecondaryBrush}"/>
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Selected">
                                <VisualState.Setters>
                                    <Setter Target="MainBorder.Background" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
                                    <Setter Target="MainBorder.BorderBrush" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
                                    <Setter Target="AppNameText.Foreground" Value="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateManager.VisualStateGroups>

                    <Grid x:Name="MainBorder">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- App Icon -->
                        <Border Grid.Column="0"
                                Background="{ThemeResource LayerFillColorAltBrush}"
                                CornerRadius="12"
                                Width="64"
                                Height="64"
                                Margin="0,0,16,0"
                                VerticalAlignment="Top">
                            <Border.Shadow>
                                <ThemeShadow/>
                            </Border.Shadow>
                            <Image Source="{x:Bind Logo}"
                                   Stretch="UniformToFill"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Center"/>
                        </Border>

                        <!-- Main Content Area -->
                        <StackPanel Grid.Column="1"
                                    Spacing="8"
                                    VerticalAlignment="Top">

                            <!-- App Name - Primary Information -->
                            <TextBlock x:Name="AppNameText"
                                       Text="{x:Bind DisplayName}"
                                       Style="{ThemeResource SubtitleTextBlockStyle}"
                                       FontWeight="SemiBold"
                                       TextWrapping="Wrap"
                                       TextTrimming="CharacterEllipsis"
                                       x:Phase="0"/>

                            <!-- Secondary Information -->
                            <controls:WrapPanel x:Name="SecondaryInfoWrapPanel"
                                              Orientation="Horizontal"
                                              HorizontalSpacing="16"
                                              VerticalSpacing="6">

                                <!-- Version -->
                                <Grid MinWidth="120">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon Grid.Column="0"
                                              Glyph="&#xE895;"
                                              FontSize="12"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              Margin="0,0,4,0"
                                              VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1"
                                               x:Uid="PFNVersionLabel"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               Margin="0,0,4,0"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{x:Bind Version}"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               x:Phase="1"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <!-- Architecture -->
                                <Grid MinWidth="120">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon Grid.Column="0"
                                              Glyph="&#xE7C4;"
                                              FontSize="12"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              Margin="0,0,4,0"
                                              VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1"
                                               x:Uid="PFNArchitectureLabel"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               Margin="0,0,4,0"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{x:Bind Architecture}"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               x:Phase="1"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <!-- Publisher -->
                                <Grid MinWidth="200" MaxWidth="300">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon Grid.Column="0"
                                              Glyph="&#xE7EE;"
                                              FontSize="12"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              Margin="0,0,4,0"
                                              VerticalAlignment="Top"/>
                                    <TextBlock Grid.Column="1"
                                               x:Uid="PFNPublisherLabel"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               Margin="0,0,4,0"
                                               VerticalAlignment="Top"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{x:Bind Publisher}"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               TextWrapping="Wrap"
                                               TextTrimming="CharacterEllipsis"
                                               x:Phase="1"/>
                                </Grid>

                                <!-- Installed Date -->
                                <Grid MinWidth="140">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon Grid.Column="0"
                                              Glyph="&#xE787;"
                                              FontSize="12"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              Margin="0,0,4,0"
                                              VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1"
                                               x:Uid="PFNInstalledDateLabel"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               Margin="0,0,4,0"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{x:Bind InstalledDate}"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               x:Phase="1"
                                               VerticalAlignment="Center"/>
                                </Grid>

                            </controls:WrapPanel>

                            <!-- Expandable Details Section -->
                            <Expander x:Name="DetailsExpander"
                                      HorizontalAlignment="Stretch"
                                      HorizontalContentAlignment="Stretch"
                                      CornerRadius="6"
                                      Background="{ThemeResource LayerFillColorAltBrush}"
                                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                      BorderThickness="1">
                                <Expander.Header>
                                    <TextBlock x:Uid="DetailsText"
                                               Style="{ThemeResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                </Expander.Header>

                                <StackPanel Spacing="6" Margin="0,8,0,0">

                                    <!-- Package Family Name -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   x:Uid="PFNLabel"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   Width="100"
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind PackageFamilyName}"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"
                                                   x:Phase="2"/>
                                    </Grid>

                                    <!-- Publisher ID -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   x:Uid="PFNPublisherID"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   Width="100"
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind PublisherID}"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"
                                                   x:Phase="2"/>
                                    </Grid>

                                    <!-- Description -->
                                    <Grid x:Name="DescriptionGrid">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   x:Uid="PFNDescription"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   Width="100"
                                                   Margin="0,0,8,0"
                                                   VerticalAlignment="Top"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind Description}"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"
                                                   x:Phase="2"/>
                                    </Grid>

                                    <!-- Install Location -->
                                    <Grid x:Name="InstallLocationGrid">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   x:Uid="PFNInstallLocation"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   Width="100"
                                                   Margin="0,0,8,0"
                                                   VerticalAlignment="Top"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind InstallLocation}"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"
                                                   x:Phase="2"/>
                                    </Grid>

                                    <!-- Full Name -->
                                    <Grid x:Name="FullnameGrid">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   x:Uid="PFNFullNameLabel"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   Width="100"
                                                   Margin="0,0,8,0"
                                                   VerticalAlignment="Top"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind FullName}"
                                                   Style="{ThemeResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"
                                                   x:Phase="2"/>
                                    </Grid>

                                </StackPanel>
                            </Expander>

                        </StackPanel>

                        <!-- Action Button Area -->
                        <StackPanel Grid.Column="2"
                                    Orientation="Vertical"
                                    Spacing="8"
                                    VerticalAlignment="Top"
                                    Margin="16,0,0,0">

                            <!-- Quick Action Button -->
                            <Button Style="{ThemeResource AccentButtonStyle}"
                                    Width="32"
                                    Height="32"
                                    Padding="0"
                                    CornerRadius="16"
                                    ToolTipService.ToolTip="Quick Actions">
                                <FontIcon Glyph="&#xE712;" FontSize="14"/>
                                <Button.Flyout>
                                    <MenuFlyout>
                                        <MenuFlyoutItem x:Uid="UninstallText"
                                                        Icon="Delete"
                                                        Click="{x:Bind ((vm:InstalledAppsManagementVM)VMRef).UninstallSingleApp_Click}"/>
                                        <MenuFlyoutItem x:Uid="OpenLocationText"
                                                        Icon="Folder"
                                                        Click="{x:Bind ((vm:InstalledAppsManagementVM)VMRef).OpenAppLocation_Click}"/>
                                        <MenuFlyoutItem x:Uid="CopyAppDetailsText"
                                                        Icon="Copy"
                                                        Click="{x:Bind ((vm:InstalledAppsManagementVM)VMRef).CopyAppDetails_Click}"/>
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>

                        </StackPanel>

                    </Grid>
                </Border>
            </DataTemplate>

        </Grid.Resources>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <controls:WrapPanel Style="{StaticResource PageHeaderWrapPanelStyle}">

            <TextBlock x:Uid="InstalledAppsManagementPageTitle" TextWrapping="WrapWholeWords" Style="{StaticResource BodyTextBlockStyle}" />

            <customUI:GuideButton NavigateUri="https://github.com/HotCakeX/Harden-Windows-Security/wiki/Manage-Installed-Apps" />

        </controls:WrapPanel>

        <customUI:InfoBarV2 Grid.Row="1"
                  IsOpen="{x:Bind ViewModel.MainInfoBarIsOpen, Mode=TwoWay}"
                  Message="{x:Bind ViewModel.MainInfoBarMessage, Mode=OneWay}"
                  Severity="{x:Bind ViewModel.MainInfoBarSeverity, Mode=OneWay}"
                  IsClosable="{x:Bind ViewModel.MainInfoBarIsClosable, Mode=OneWay}" />

        <Border Grid.Row="2" Margin="0,10,0,10" Style="{StaticResource GridCardStyle}" Padding="8">

            <controls:WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      HorizontalSpacing="10"
                      VerticalSpacing="10">

                <ProgressRing Visibility="{x:Bind ViewModel.ProgressBarVisibility,Mode=OneWay}"
                              VerticalAlignment="Center"
                              IsIndeterminate="True" />

                <TextBox x:Uid="SearchForAppsPlaceHolder"
                         MinWidth="200"
                         Text="{x:Bind ViewModel.SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}"
                         VerticalAlignment="Center"/>

                <!-- Total and Filtered Count Display Border -->
                <Border Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                        CornerRadius="6"
                        Padding="12,8"
                        BorderThickness="0">

                    <TextBlock VerticalAlignment="Center"
                               FontSize="14"
                               FontWeight="SemiBold">
                        <Run x:Uid="TotalText"/>
                        <Run Text="{x:Bind ViewModel.TotalItemsCount, Mode=OneWay}"/>
                        <Run Text=" | Displayed: "/>
                        <Run Text="{x:Bind ViewModel.FilteredItemsCount, Mode=OneWay}"/>
                    </TextBlock>
                </Border>

                <Button IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}"
                        VerticalAlignment="Center"
                        Click="{x:Bind ViewModel.RefreshAppsListButton_Click}">

                    <StackPanel Orientation="Horizontal" Spacing="4">

                        <AnimatedIcon Height="18" Width="18">
                            <AnimatedIcon.Source>
                                <animatedvisuals:MindMap/>
                            </AnimatedIcon.Source>
                        </AnimatedIcon>

                        <TextBlock x:Uid="GetAppsListText"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                </Button>

                <!-- Uninstall Selected Apps Button -->
                <Button IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}"
                        VerticalAlignment="Center"
                        Click="{x:Bind ViewModel.UninstallSelectedApps_Click}">
                    <StackPanel Orientation="Horizontal" Spacing="4">

                        <AnimatedIcon Height="18" Width="18">
                            <AnimatedIcon.Source>
                                <animatedvisuals:Caution/>
                            </AnimatedIcon.Source>
                        </AnimatedIcon>

                        <TextBlock x:Uid="UninstallSelectedAppsText"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <DropDownButton x:Uid="ManageSelectionsDropDownButton">

                    <DropDownButton.Flyout>
                        <MenuFlyout Placement="Bottom">
                            <MenuFlyoutItem x:Uid="SelectAllMenuFlyoutItem" IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}" Click="{x:Bind ViewModel.SelectAllMenuFlyoutItem_Click}">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE8B3;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>

                            <MenuFlyoutItem x:Uid="RemoveSelectionsMenuFlyoutItem" IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}" Click="{x:Bind ViewModel.RemoveSelectionsMenuFlyoutItem_Click}">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE8E6;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>

                        </MenuFlyout>
                    </DropDownButton.Flyout>
                </DropDownButton>

                <!-- Selected Items Count Badge -->
                <Border Background="#aa4b6b"
                        CornerRadius="12"
                        Padding="12,8">

                    <TextBlock FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="WhiteSmoke"
                               VerticalAlignment="Center">
                        <Run Text="Selected: "/>
                        <Run Text="{x:Bind ViewModel.SelectedItemsCount, Mode=OneWay}"/>
                    </TextBlock>
                </Border>

            </controls:WrapPanel>
        </Border>


        <RefreshContainer Grid.Row="3"
                          IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}"
                          RefreshRequested="{x:Bind ViewModel.RefreshAppsListButton_Click}">

            <ListView IsEnabled="{x:Bind ViewModel.ElementsAreEnabled, Mode=OneWay}"
                      ItemsSource="{x:Bind PackagedAppsCollectionViewSource.View, Mode=OneWay}"
                      Loaded="{x:Bind ViewModel.MainListView_Loaded}"
                      SelectionChanged="{x:Bind ViewModel.MainListView_SelectionChanged}"
                      SelectionMode="Multiple"
                      ItemTemplate="{StaticResource PackagedAppsListViewTemplate}">

                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel AreStickyGroupHeadersEnabled="True"/>
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
                <ListView.GroupStyle>
                    <GroupStyle >
                        <GroupStyle.HeaderTemplate>
                            <DataTemplate x:DataType="CC:GroupInfoListForPackagedAppView">
                                <Border AutomationProperties.AccessibilityView="Raw">
                                    <TextBlock Text="{x:Bind Key}" Style="{ThemeResource TitleTextBlockStyle}" AutomationProperties.AccessibilityView="Raw"/>
                                </Border>
                            </DataTemplate>
                        </GroupStyle.HeaderTemplate>
                    </GroupStyle>
                </ListView.GroupStyle>

            </ListView>

        </RefreshContainer>

    </Grid>
</Page>